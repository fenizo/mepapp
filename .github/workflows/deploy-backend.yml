name: Deploy Backend
on:
  push:
    branches: [ master ]
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Build with Maven
      run: mvn -f mep-backend/pom.xml clean package -DskipTests -X
    - name: Deploy to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        source: "mep-backend/target/*.jar"
        target: "~/apps/mep-backend"
    - name: Restart Backend Service
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.BACKEND_SERVER_USER }}
        password: ${{ secrets.BACKEND_SERVER_PASSWORD }}
        script: |
          # Try to load environment
          for f in /etc/profile ~/.profile ~/.bash_profile ~/.bashrc; do
            [ -f "$f" ] && . "$f" && echo "Sourced $f"
          done
          
          export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin
          
          # Find PM2
          PM2_BIN=$(command -v pm2 || which pm2 || find /usr/local/bin /usr/bin /opt -name pm2 -type f 2>/dev/null | head -n 1)
          
          if [ -n "$PM2_BIN" ]; then
            echo "Using PM2 at: $PM2_BIN"
            $PM2_BIN delete mep-backend || true
            $PM2_BIN start "java -jar -Dserver.port=8085 ~/apps/mep-backend/mep-backend/target/backend-0.0.1-SNAPSHOT.jar" --name mep-backend
            
            # Wait for backend to start and register a test user
            sleep 15
            curl -X POST http://localhost:8085/api/auth/register \
              -H "Content-Type: application/json" \
              -d '{"name": "Field Staff", "phone": "1234567890", "password": "1234", "role": "STAFF"}' || true
          else
            echo "PM2 not found. Falling back to nohup."
            export PATH=$PATH:/home/${{ secrets.BACKEND_SERVER_USER }}/.nvm/versions/node/v22.13.0/bin
            if [ -f ~/.bashrc ]; then source ~/.bashrc; fi
            if [ -f ~/.profile ]; then source ~/.profile; fi
            
            # Kill existing process on port 8085
            fuser -k 8085/tcp || true
            
            # Start Java app with robust nohup
            cd /home/${{ secrets.BACKEND_SERVER_USER }}/mep-backend
            nohup java -jar target/*.jar > app.log 2>&1 &
            
            # Wait for process to initialize
            echo "Waiting for backend to start..."
            sleep 10
            
            # Verify process is running
            echo "Checking process status:"
            ps -ef | grep java
            
            # Check log for immediate errors
            echo "Initial Log Output:"
            head -n 20 app.log

            # Wait a few more seconds and register a test user for the mobile app
            sleep 5
            curl -X POST http://localhost:8085/api/auth/register \
              -H "Content-Type: application/json" \
              -d '{"name": "Field Staff", "phone": "1234567890", "password": "1234", "role": "STAFF"}' || true
          fi
